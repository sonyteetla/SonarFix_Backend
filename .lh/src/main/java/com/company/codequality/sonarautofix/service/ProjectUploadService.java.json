{
    "sourceFile": "src/main/java/com/company/codequality/sonarautofix/service/ProjectUploadService.java",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772176515494,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772176515494,
            "name": "Commit-0",
            "content": "package com.company.codequality.sonarautofix.service;\r\n\r\nimport java.util.List;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.web.multipart.MultipartFile;\r\n\r\nimport java.io.*;\r\nimport java.nio.file.*;\r\nimport java.time.LocalDateTime;\r\nimport java.util.zip.ZipEntry;\r\nimport java.util.zip.ZipInputStream;\r\n\r\n@Service\r\npublic class ProjectUploadService {\r\n\r\n    private static final String WORKSPACE = \"C:/sonar-workspace/\";\r\n\r\n\r\n    // ------------------ ZIP Upload ------------------\r\n\r\n    //  ZIP Upload\r\n\r\n    public String handleZipUpload(MultipartFile file) {\r\n        try {\r\n            String projectDir = WORKSPACE + System.currentTimeMillis();\r\n            Files.createDirectories(Paths.get(projectDir));\r\n\r\n            try (ZipInputStream zis = new ZipInputStream(file.getInputStream())) {\r\n                ZipEntry entry;\r\n\r\n                while ((entry = zis.getNextEntry()) != null) {\r\n                    Path newFile = Paths.get(projectDir, entry.getName());\r\n\r\n                    if (entry.isDirectory()) {\r\n                        Files.createDirectories(newFile);\r\n                    } else {\r\n                        Files.createDirectories(newFile.getParent());\r\n                        try (OutputStream fos = Files.newOutputStream(newFile)) {\r\n                            byte[] buffer = new byte[8192];\r\n                            int len;\r\n                            while ((len = zis.read(buffer)) > 0) {\r\n                                fos.write(buffer, 0, len);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            return projectDir;\r\n\r\n        } catch (Exception e) {\r\n            throw new RuntimeException(\"ZIP Upload failed: \" + e.getMessage(), e);\r\n        }\r\n    }\r\n\r\n\r\n    // ------------------ GitHub Clone ------------------\r\n\r\n    //  GitHub Clone\r\n\r\n    public String cloneGithub(String repoUrl) {\r\n        try {\r\n            String projectDir = WORKSPACE + System.currentTimeMillis();\r\n\r\n            ProcessBuilder builder = new ProcessBuilder(\"C:\\\\Program Files\\\\Git\\\\bin\\\\git.exe\", \"clone\", repoUrl, projectDir);\r\n            Process process = builder.start();\r\n            process.waitFor();\r\n\r\n            if (process.exitValue() != 0) {\r\n                throw new RuntimeException(\"Git clone failed, exit code: \" + process.exitValue());\r\n            }\r\n\r\n            return projectDir;\r\n\r\n        } catch (Exception e) {\r\n            throw new RuntimeException(\"Git clone failed: \" + e.getMessage(), e);\r\n        }\r\n    }\r\n\r\n\r\n    // ------------------ Local Directory ------------------\r\n\r\n    //  Local Directory\r\n\r\n    public String useLocalDirectory(String localPath) {\r\n        Path src = Paths.get(localPath);\r\n\r\n        if (!Files.exists(src) || !Files.isDirectory(src)) {\r\n            throw new RuntimeException(\"Invalid local directory\");\r\n        }\r\n\r\n        String projectDir = WORKSPACE + System.currentTimeMillis();\r\n        Path dest = Paths.get(projectDir);\r\n\r\n        try {\r\n            Files.walk(src).forEach(source -> {\r\n                try {\r\n                    Path target = dest.resolve(src.relativize(source));\r\n                    if (Files.isDirectory(source)) {\r\n                        Files.createDirectories(target);\r\n                    } else {\r\n                        Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);\r\n                    }\r\n                } catch (IOException e) {\r\n                    throw new RuntimeException(e);\r\n                }\r\n            });\r\n\r\n            return projectDir;\r\n        } catch (IOException e) {\r\n            throw new RuntimeException(\"Local directory copy failed: \" + e.getMessage(), e);\r\n        }\r\n    }\r\n\r\n\r\n    // ------------------ Copy Project for Fixing ------------------\r\n    public String copyProject(String originalPath) throws IOException {\r\n\r\n        Path sourcePath = Paths.get(originalPath);\r\n\r\n        // Determine fixed path safely (avoid _fixed duplication)\r\n        String fixedPathStr = originalPath.endsWith(\"_fixed\") ? originalPath : originalPath + \"_fixed\";\r\n        Path fixedPath = Paths.get(fixedPathStr);\r\n\r\n        // Delete old fixed folder if exists\r\n        if (Files.exists(fixedPath)) {\r\n            deleteDirectory(fixedPath);\r\n        }\r\n\r\n        // Copy project recursively\r\n        Files.walk(sourcePath).forEach(source -> {\r\n            try {\r\n                Path target = fixedPath.resolve(sourcePath.relativize(source));\r\n                if (Files.isDirectory(source)) {\r\n                    Files.createDirectories(target);\r\n                } else {\r\n                    Files.copy(source, target, StandardCopyOption.REPLACE_EXISTING);\r\n                }\r\n            } catch (IOException e) {\r\n                throw new RuntimeException(\"Failed to copy file: \" + source, e);\r\n            }\r\n        });\r\n\r\n        return fixedPath.toString();\r\n    }\r\n\r\n    // ------------------ Helper: Delete directory recursively ------------------\r\n    private void deleteDirectory(Path path) throws IOException {\r\n        if (!Files.exists(path)) return;\r\n\r\n        Files.walk(path)\r\n                .sorted((a, b) -> b.compareTo(a)) // delete children first\r\n                .forEach(p -> {\r\n                    try {\r\n                        Files.delete(p);\r\n                    } catch (IOException e) {\r\n                        throw new RuntimeException(\"Failed to delete: \" + p, e);\r\n                    }\r\n                });\r\n    }\r\n    \r\n    //METADATA WRITER\r\n\r\n    public void registerProjectKey(String projectDir, String projectKey) {\r\n\r\n        try {\r\n            Path metadata = Paths.get(projectDir, \".project-key\");\r\n            Files.writeString(metadata, projectKey);\r\n        } catch (IOException e) {\r\n            throw new RuntimeException(\"Failed to store project key\", e);\r\n        }\r\n    }\r\n    \r\n}\r\n\r\n"
        }
    ]
}