{
    "sourceFile": "src/main/java/com/company/codequality/sonarautofix/service/RuleEngineService.java",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772176250812,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772176250812,
            "name": "Commit-0",
            "content": "package com.company.codequality.sonarautofix.service;\r\n\r\nimport com.company.codequality.sonarautofix.config.RuleRegistry;\r\nimport com.company.codequality.sonarautofix.model.*;\r\nimport com.fasterxml.jackson.databind.JsonNode;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\nimport org.jsoup.Jsoup;\r\nimport org.jsoup.nodes.Element;\r\n\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.http.*;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.web.client.RestTemplate;\r\n\r\nimport java.util.*;\r\nimport java.util.concurrent.ConcurrentHashMap;\r\nimport java.util.stream.Collectors;\r\n\r\n@Service\r\npublic class RuleEngineService {\r\n\r\n@Value(\"${sonar.host.url}\")  \r\nprivate String sonarUrl;  \r\n\r\n@Value(\"${sonar.token}\")  \r\nprivate String token;  \r\n\r\nprivate final RuleRegistry ruleRegistry;  \r\nprivate final RestTemplate restTemplate;  \r\nprivate final ObjectMapper objectMapper;  \r\n\r\nprivate final Map<String, RuleDescriptionData> ruleCache =  \r\n        new ConcurrentHashMap<>();  \r\n\r\npublic RuleEngineService(RuleRegistry ruleRegistry,  \r\n                         RestTemplate restTemplate,  \r\n                         ObjectMapper objectMapper) {  \r\n    this.ruleRegistry = ruleRegistry;  \r\n    this.restTemplate = restTemplate;  \r\n    this.objectMapper = objectMapper;  \r\n}  \r\n\r\n// ================= ENRICH ISSUES =================  \r\n\r\npublic void enrichIssues(List<Issue> issues) {  \r\n\r\n    if (issues == null || issues.isEmpty()) return;  \r\n\r\n    Set<String> ruleKeys = issues.stream()  \r\n            .map(Issue::getRule)  \r\n            .collect(Collectors.toSet());  \r\n\r\n    fetchMissingRuleData(ruleKeys);  \r\n\r\n    for (Issue issue : issues) {  \r\n\r\n        RuleDescriptionData data = ruleCache.get(issue.getRule());  \r\n\r\n        if (data != null) {  \r\n            issue.setWhyBlocks(data.getWhyBlocks());  \r\n            issue.setNonCompliantExample(data.getNonCompliantExample());  \r\n            issue.setCompliantExample(data.getCompliantExample());  \r\n        }  \r\n\r\n        RuleConfig rule = ruleRegistry.getRule(issue.getRule());  \r\n\r\n        if (rule != null) {  \r\n            issue.setSupported(true);  \r\n            issue.setAutoFixable(rule.isAutoFixable());  \r\n\r\n            try {  \r\n                issue.setFixType(FixType.valueOf(rule.getFixType()));  \r\n            } catch (Exception e) {  \r\n                issue.setFixType(FixType.NONE);  \r\n            }  \r\n        } else {  \r\n            issue.setSupported(false);  \r\n            issue.setAutoFixable(false);  \r\n            issue.setFixType(FixType.NONE);  \r\n        }  \r\n    }  \r\n}  \r\n\r\n// ================= FETCH RULE DATA =================  \r\n\r\nprivate void fetchMissingRuleData(Set<String> ruleKeys) {  \r\n\r\n    HttpHeaders headers = new HttpHeaders();  \r\n    headers.setBasicAuth(token, \"\");  \r\n    HttpEntity<Void> entity = new HttpEntity<>(headers);  \r\n\r\n    for (String ruleKey : ruleKeys) {  \r\n\r\n        if (ruleCache.containsKey(ruleKey)) continue;  \r\n\r\n        try {  \r\n\r\n            String url = sonarUrl + \"/api/rules/show?key=\" + ruleKey;  \r\n\r\n            ResponseEntity<String> response =  \r\n                    restTemplate.exchange(url,  \r\n                            HttpMethod.GET,  \r\n                            entity,  \r\n                            String.class);  \r\n\r\n            JsonNode root = objectMapper.readTree(response.getBody());  \r\n            JsonNode ruleNode = root.path(\"rule\");  \r\n\r\n            String whyHtml = \"\";  \r\n            String fixHtml = \"\";  \r\n\r\n            if (ruleNode.has(\"descriptionSections\")) {  \r\n\r\n                for (JsonNode section :  \r\n                        ruleNode.path(\"descriptionSections\")) {  \r\n\r\n                    String key =  \r\n                            section.path(\"key\").asText().toLowerCase();  \r\n\r\n                    String content =  \r\n                            section.path(\"content\").asText();  \r\n\r\n                    if (\"root_cause\".equals(key)) {  \r\n                        whyHtml = content;  \r\n                    }  \r\n\r\n                    if (\"how_to_fix\".equals(key)) {  \r\n                        fixHtml = content;  \r\n                    }  \r\n                }  \r\n            }  \r\n\r\n            List<ContentBlock> whyBlocks =  \r\n                    parseHtmlToBlocks(whyHtml);  \r\n\r\n            List<ContentBlock> fixBlocks =  \r\n                    parseHtmlToBlocks(fixHtml);  \r\n\r\n            Map<String, String> examples =  \r\n                    extractCodeExamplesFromAllSections(ruleNode);  \r\n\r\n            ruleCache.put(ruleKey,  \r\n                    new RuleDescriptionData(  \r\n                            whyBlocks,  \r\n                            fixBlocks,  \r\n                            examples.get(\"non\"),  \r\n                            examples.get(\"compliant\")  \r\n                    )  \r\n            );  \r\n\r\n        } catch (Exception e) {  \r\n\r\n            ruleCache.put(ruleKey,  \r\n                    new RuleDescriptionData(  \r\n                            Collections.singletonList(  \r\n                                    new ContentBlock(  \r\n                                            \"paragraph\",  \r\n                                            \"Description unavailable\"  \r\n                                    )  \r\n                            ),  \r\n                            new ArrayList<>(),  \r\n                            \"\",  \r\n                            \"\"  \r\n                    )  \r\n            );  \r\n        }  \r\n    }  \r\n}  \r\n\r\n// ================= HTML â†’ BLOCKS =================  \r\n\r\nprivate List<ContentBlock> parseHtmlToBlocks(String html) {  \r\n\r\n    List<ContentBlock> blocks = new ArrayList<>();  \r\n\r\n    if (html == null || html.isBlank()) return blocks;  \r\n\r\n    org.jsoup.nodes.Document doc = Jsoup.parse(html);  \r\n\r\n    for (Element el : doc.body().children()) {  \r\n\r\n        switch (el.tagName()) {  \r\n\r\n            case \"h1\":  \r\n            case \"h2\":  \r\n            case \"h3\":  \r\n                blocks.add(new ContentBlock(  \r\n                        \"heading\",  \r\n                        el.text()  \r\n                ));  \r\n                break;  \r\n\r\n            case \"p\":  \r\n                blocks.add(new ContentBlock(  \r\n                        \"paragraph\",  \r\n                        el.text()  \r\n                ));  \r\n                break;  \r\n\r\n            case \"ul\":  \r\n                blocks.add(new ContentBlock(  \r\n                        \"unordered_list\",  \r\n                        el.select(\"li\")  \r\n                          .stream()  \r\n                          .map(Element::text)  \r\n                          .collect(Collectors.toList())  \r\n                ));  \r\n                break;  \r\n\r\n            case \"ol\":  \r\n                blocks.add(new ContentBlock(  \r\n                        \"ordered_list\",  \r\n                        el.select(\"li\")  \r\n                          .stream()  \r\n                          .map(Element::text)  \r\n                          .collect(Collectors.toList())  \r\n                ));  \r\n                break;  \r\n\r\n            default:  \r\n                break;  \r\n        }  \r\n    }  \r\n\r\n    return blocks;  \r\n}  \r\n\r\n// ================= EXTRACT CODE EXAMPLES =================  \r\n\r\nprivate Map<String, String> extractCodeExamplesFromAllSections(JsonNode ruleNode) {  \r\n\r\n    Map<String, String> result = new HashMap<>();  \r\n    result.put(\"non\", \"\");  \r\n    result.put(\"compliant\", \"\");  \r\n\r\n    StringBuilder non = new StringBuilder();  \r\n    StringBuilder compliant = new StringBuilder();  \r\n\r\n    if (!ruleNode.has(\"descriptionSections\")) {  \r\n        return result;  \r\n    }  \r\n\r\n    for (JsonNode section : ruleNode.get(\"descriptionSections\")) {  \r\n\r\n        String html = section.path(\"content\").asText();  \r\n        if (html == null || html.isBlank()) continue;  \r\n\r\n        org.jsoup.nodes.Document doc = Jsoup.parse(html);  \r\n\r\n        String currentMode = null; // \"non\" or \"compliant\"  \r\n\r\n        for (org.jsoup.nodes.Element el : doc.body().children()) {  \r\n\r\n            String tag = el.tagName();  \r\n            String text = el.text().toLowerCase();  \r\n\r\n            // Detect section switch \r\n            if (tag.matches(\"h1|h2|h3|h4|strong\")) {  \r\n\r\n                if (text.contains(\"noncompliant\")) {  \r\n                    currentMode = \"non\";  \r\n                    continue;  \r\n                }  \r\n\r\n                if (text.contains(\"compliant\")) {  \r\n                    currentMode = \"compliant\";  \r\n                    continue;  \r\n                }  \r\n            }  \r\n\r\n            // Capture code blocks  \r\n            if (tag.equals(\"pre\") && currentMode != null) {  \r\n\r\n                if (currentMode.equals(\"non\")) {  \r\n                    non.append(el.text()).append(\"\\n\\n\");  \r\n                }  \r\n\r\n                if (currentMode.equals(\"compliant\")) {  \r\n                    compliant.append(el.text()).append(\"\\n\\n\");  \r\n                }  \r\n            }  \r\n        }  \r\n    }  \r\n\r\n    result.put(\"non\", non.toString().trim());  \r\n    result.put(\"compliant\", compliant.toString().trim());  \r\n\r\n    return result;  \r\n}\r\n\r\n}\r\n\r\n"
        }
    ]
}