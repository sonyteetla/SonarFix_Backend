{
    "sourceFile": "src/main/java/com/company/codequality/sonarautofix/controller/FileContentController.java",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1772176287119,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1772176287119,
            "name": "Commit-0",
            "content": "\r\npackage com.company.codequality.sonarautofix.controller;\r\n\r\nimport com.company.codequality.sonarautofix.model.*;\r\nimport com.company.codequality.sonarautofix.service.FileContentService;\r\nimport com.company.codequality.sonarautofix.service.ScanIssueService;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.Comparator;\r\nimport java.util.List;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/files\")\r\npublic class FileContentController {\r\n\r\n    private final FileContentService fileContentService;\r\n    private final ScanIssueService scanIssueService;\r\n\r\n    public FileContentController(FileContentService fileContentService,\r\n                                 ScanIssueService scanIssueService) {\r\n        this.fileContentService = fileContentService;\r\n        this.scanIssueService = scanIssueService;\r\n    }\r\n\r\n    @GetMapping(\"/{projectKey}\")\r\n    public FileContentResponse getFileContent(\r\n            @PathVariable String projectKey,\r\n            @RequestParam String filePath) {\r\n\r\n        List<String> rawLines =\r\n                fileContentService.getFileContent(projectKey, filePath);\r\n\r\n        List<Issue> allIssues =\r\n                scanIssueService.fetchAllIssues(projectKey, null, null, null);\r\n\r\n        List<Issue> issuesForFile =\r\n                allIssues.stream()\r\n                        .filter(issue -> filePath.equals(issue.getFilePath()))\r\n                        .toList();\r\n\r\n        List<FileLine> fileLines = new ArrayList<>();\r\n\r\n        for (int i = 0; i < rawLines.size(); i++) {\r\n\r\n            final int lineNumber = i + 1;\r\n            final String lineContent = rawLines.get(i);\r\n\r\n            List<Issue> lineIssues =\r\n                    issuesForFile.stream()\r\n                            .filter(issue ->\r\n                                    issue.getStartLine() != null &&\r\n                                    issue.getStartLine() == lineNumber)\r\n                            .sorted(Comparator.comparing(Issue::getStartOffset))\r\n                            .toList();\r\n\r\n            List<HighlightSegment> segments = new ArrayList<>();\r\n\r\n            if (lineIssues.isEmpty()) {\r\n\r\n                segments.add(\r\n                        HighlightSegment.builder()\r\n                                .text(lineContent)\r\n                                .highlighted(false)\r\n                                .build()\r\n                );\r\n\r\n            } else {\r\n\r\n                int currentIndex = 0;\r\n\r\n                for (Issue issue : lineIssues) {\r\n\r\n                    int start = issue.getStartOffset() != null ? issue.getStartOffset() : 0;\r\n                    int end = issue.getEndOffset() != null ? issue.getEndOffset() : 0;\r\n\r\n                    if (start > currentIndex) {\r\n                        segments.add(\r\n                                HighlightSegment.builder()\r\n                                        .text(lineContent.substring(currentIndex, start))\r\n                                        .highlighted(false)\r\n                                        .build()\r\n                        );\r\n                    }\r\n\r\n                    segments.add(\r\n                            HighlightSegment.builder()\r\n                                    .text(lineContent.substring(start, end))\r\n                                    .highlighted(true)\r\n                                    .build()\r\n                    );\r\n\r\n                    currentIndex = end;\r\n                }\r\n\r\n                if (currentIndex < lineContent.length()) {\r\n                    segments.add(\r\n                            HighlightSegment.builder()\r\n                                    .text(lineContent.substring(currentIndex))\r\n                                    .highlighted(false)\r\n                                    .build()\r\n                    );\r\n                }\r\n            }\r\n\r\n            fileLines.add(\r\n                    FileLine.builder()\r\n                            .lineNumber(lineNumber)\r\n                            .segments(segments)\r\n                            .issues(lineIssues)\r\n                            .build()\r\n            );\r\n        }\r\n\r\n        return FileContentResponse.builder()\r\n                .filePath(filePath)\r\n                .lines(fileLines)\r\n                .build();\r\n    }\r\n}\r\n"
        }
    ]
}