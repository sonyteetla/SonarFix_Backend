{
    "sourceFile": "src/main/java/com/company/codequality/sonarautofix/service/ScanService.java",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1772176623668,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1772176631248,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -239,84 +239,4 @@\n \r\n         return task.getSuggestions();\r\n     }\r\n }\r\n-package com.company.codequality.sonarautofix.service;\r\n-\r\n-import com.company.codequality.sonarautofix.model.ScanTask;\r\n-import org.springframework.beans.factory.annotation.Value;\r\n-import org.springframework.stereotype.Service;\r\n-\r\n-import java.io.BufferedReader;\r\n-import java.io.InputStreamReader;\r\n-\r\n-@Service\r\n-public class SonarService {\r\n-\r\n-    @Value(\"${sonar.token}\")\r\n-    private String token;\r\n-\r\n-    @Value(\"${sonar.host.url}\")\r\n-    private String sonarHost;\r\n-\r\n-    /**\r\n-     * Runs Maven + Sonar scan\r\n-     * Captures full build log into ScanTask\r\n-     */\r\n-    public void runSonarScan(String projectPath,\r\n-            String projectKey,\r\n-            ScanTask task) {\r\n-\r\n-StringBuilder output = new StringBuilder();\r\n-\r\n-try {\r\n-\r\n-ProcessBuilder builder = new ProcessBuilder(\r\n-        \"C:\\\\Program Files\\\\Apache\\\\Maven\\\\bin\\\\mvn.cmd\",\r\n-        \"clean\",\r\n-        \"verify\",\r\n-        \"-DskipTests=true\",\r\n-        \"org.sonarsource.scanner.maven:sonar-maven-plugin:sonar\",\r\n-        \"-Dsonar.projectKey=\" + projectKey,\r\n-        \"-Dsonar.host.url=http://localhost:9000\",\r\n-        \"-Dsonar.token=\" + token\r\n-\r\n-);\r\n-\r\n-builder.directory(new java.io.File(projectPath));\r\n-builder.redirectErrorStream(true);\r\n-\r\n-\r\n-Process process = builder.start();\r\n-\r\n-try (BufferedReader reader =\r\n-        new BufferedReader(\r\n-                new InputStreamReader(process.getInputStream()))) {\r\n-\r\n-String line;\r\n-\r\n-while ((line = reader.readLine()) != null) {\r\n-   output.append(line).append(\"\\n\");\r\n-}\r\n-}\r\n-\r\n-int exitCode = process.waitFor();\r\n-\r\n-task.setBuildLog(output.toString());\r\n-\r\n-if (exitCode != 0) {\r\n-throw new RuntimeException(\r\n-       \"Sonar scan failed. Exit code: \" + exitCode\r\n-);\r\n-}\r\n-\r\n-} catch (Exception e) {\r\n-\r\n-task.setBuildLog(output.toString());\r\n-\r\n-throw new RuntimeException(\r\n-   \"Sonar Scan Failed: \" + e.getMessage(),\r\n-   e\r\n-);\r\n-}\r\n-}\r\n-}\r\n"
                }
            ],
            "date": 1772176623668,
            "name": "Commit-0",
            "content": "package com.company.codequality.sonarautofix.service;\r\n\r\nimport com.company.codequality.sonarautofix.model.*;\r\nimport com.company.codequality.sonarautofix.repository.ScanRepository;\r\nimport com.company.codequality.sonarautofix.util.ProjectZipUtil;\r\n\r\nimport org.springframework.scheduling.annotation.Async;\r\nimport org.springframework.stereotype.Service;\r\n\r\nimport java.util.*;\r\n\r\n@Service\r\npublic class ScanService {\r\n\r\n    private final SonarService sonarService;\r\n    private final AutoFixEngine autoFixEngine;\r\n    private final ProjectUploadService projectUploadService;\r\n    private final ScanIssueService scanIssueService;\r\n    private final ProjectService projectService;\r\n    private final ScanRepository scanRepository;\r\n\r\n    public ScanService(SonarService sonarService,\r\n                       ProjectUploadService projectUploadService,\r\n                       AutoFixEngine autoFixEngine,\r\n                       ScanIssueService scanIssueService,\r\n                       ProjectService projectService,\r\n                       ScanRepository scanRepository) {\r\n\r\n        this.sonarService = sonarService;\r\n        this.projectUploadService = projectUploadService;\r\n        this.autoFixEngine = autoFixEngine;\r\n        this.scanIssueService = scanIssueService;\r\n        this.projectService = projectService;\r\n        this.scanRepository = scanRepository;\r\n    }\r\n\r\n    // ================= NEW PROJECT SCAN =================\r\n    public String startNewScan(String projectPath) {\r\n\r\n        String executionId = UUID.randomUUID().toString();\r\n        String projectKey = \"auto-project-\" + executionId;\r\n\r\n        Project project = Project.builder()\r\n                .projectKey(projectKey)\r\n                .description(\"Auto-scan for: \" + projectPath)\r\n                .build();\r\n\r\n        projectService.registerProject(project);\r\n        projectUploadService.registerProjectKey(projectPath, projectKey);\r\n\r\n        return startScanInternal(projectPath, projectKey, executionId);\r\n    }\r\n    \r\n    //Manual Rescan\r\n    public String reScan(String projectPath, String projectKey) {\r\n\r\n        String executionId = UUID.randomUUID().toString();\r\n        return startScanInternal(projectPath, projectKey, executionId);\r\n    }\r\n\r\n    // ================= AUTO FIX RE-SCAN =================\r\n    public void reScan(String projectPath,\r\n            String projectKey,\r\n            String scanId) {\r\n\r\n      ScanTask task = scanRepository.findById(scanId);\r\n      if (task == null) {\r\n        throw new IllegalArgumentException(\"Scan not found\");\r\n     }\r\n      task.setStatus(\"QUEUED\");\r\n      task.setMappedIssues(null);\r\n      task.setResult(null);\r\n      scanRepository.save(task);\r\n      runScanAsync(task);\r\n    }\r\n\r\n    private String startScanInternal(String projectPath,\r\n                                     String projectKey,\r\n                                     String executionId) {\r\n\r\n        ScanTask task = new ScanTask(executionId, projectPath);\r\n        task.setProjectKey(projectKey);\r\n        task.setStatus(\"QUEUED\");\r\n\r\n        scanRepository.save(task);\r\n        runScanAsync(task);\r\n\r\n        return executionId;\r\n    }\r\n\r\n    // ================= RUN SCAN =================\r\n    @Async\r\n    public void runScanAsync(ScanTask task) {\r\n\r\n        try {\r\n            task.setStatus(\"RUNNING\");\r\n            scanRepository.save(task);\r\n\r\n            // Run sonar once\r\n            sonarService.runSonarScan(\r\n                    task.getProjectPath(),\r\n                    task.getProjectKey(),\r\n                    task\r\n            );\r\n\r\n            // Retry fetching issues\r\n            List<Issue> issues = new ArrayList<>();\r\n            int maxRetries = 5;\r\n\r\n            for (int i = 0; i < maxRetries; i++) {\r\n\r\n                issues = scanIssueService.fetchAllIssues(\r\n                        task.getProjectKey(), null, null, null);\r\n\r\n                if (!issues.isEmpty()) break;\r\n\r\n                Thread.sleep(3000);\r\n            }\r\n\r\n            List<MappedIssue> mappedIssues =\r\n                    scanIssueService.toMappedIssues(issues);\r\n\r\n            task.setMappedIssues(mappedIssues);\r\n            task.setStatus(\"COMPLETED\");\r\n\r\n            scanRepository.save(task);\r\n\r\n        } catch (Exception e) {\r\n\r\n            task.setStatus(\"FAILED\");\r\n            task.setResult(e.getMessage());\r\n            scanRepository.save(task);\r\n        }\r\n    }\r\n\r\n    // ================= APPLY AUTO FIX =================\r\n    public int applyAutoFix(String scanId,\r\n                            List<FixRequest> requests) {\r\n\r\n        ScanTask task = scanRepository.findById(scanId);\r\n\r\n        if (task == null) {\r\n            throw new IllegalArgumentException(\"Scan not found\");\r\n        }\r\n\r\n        return autoFixEngine.applyFixes(\r\n                requests,\r\n                task.getProjectPath(),\r\n                task.getProjectKey(),\r\n                scanId\r\n        );\r\n    }\r\n\r\n    // ================= AUTO FIX ALL =================\r\n    public String autoFixAll(String scanId) {\r\n\r\n        ScanTask task = scanRepository.findById(scanId);\r\n\r\n        if (task == null) {\r\n            throw new IllegalArgumentException(\"Scan not found\");\r\n        }\r\n\r\n        if (!\"COMPLETED\".equals(task.getStatus())) {\r\n            throw new IllegalStateException(\"Scan not completed yet\");\r\n        }\r\n\r\n        List<MappedIssue> issues = task.getMappedIssues();\r\n\r\n        if (issues == null || issues.isEmpty()) {\r\n            throw new IllegalStateException(\"No issues found\");\r\n        }\r\n\r\n        List<FixRequest> requests = new ArrayList<>();\r\n\r\n        for (MappedIssue issue : issues) {\r\n\r\n            if (issue.isAutoFixable() && issue.getFixType() != null) {\r\n\r\n                String realPath = issue.getFile();\r\n                int idx = realPath.indexOf(\":\");\r\n                if (idx != -1) {\r\n                    realPath = realPath.substring(idx + 1);\r\n                }\r\n\r\n                requests.add(\r\n                        new FixRequest(\r\n                                realPath,\r\n                                issue.getLine(),\r\n                                issue.getFixType()));\r\n            }\r\n        }\r\n\r\n        if (requests.isEmpty()) {\r\n            throw new IllegalStateException(\"No auto-fixable issues\");\r\n        }\r\n\r\n        autoFixEngine.applyFixes(\r\n                requests,\r\n                task.getProjectPath(),\r\n                task.getProjectKey(),\r\n                scanId\r\n        );\r\n\r\n        return scanId;\r\n    }\r\n\r\n    // ================= STATUS =================\r\n    public String getStatus(String scanId) {\r\n        ScanTask task = scanRepository.findById(scanId);\r\n        return task == null ? \"NOT_FOUND\" : task.getStatus();\r\n    }\r\n\r\n    public String getResult(String scanId) {\r\n        ScanTask task = scanRepository.findById(scanId);\r\n\r\n        if (task == null) return \"NOT_FOUND\";\r\n        if (!\"COMPLETED\".equals(task.getStatus()))\r\n            return \"SCAN_NOT_FINISHED\";\r\n\r\n        return task.getResult();\r\n    }\r\n\r\n    public ScanTask getScanTask(String scanId) {\r\n        return scanRepository.findById(scanId);\r\n    }\r\n\r\n    public List<ScanTask> getAllScans() {\r\n        return scanRepository.findAll();\r\n    }\r\n\r\n    // ================= GET SUGGESTIONS =================\r\n    public List<FixSuggestion> getSuggestions(String scanId) {\r\n\r\n        ScanTask task = scanRepository.findById(scanId);\r\n\r\n        if (task == null || task.getSuggestions() == null) {\r\n            return Collections.emptyList();\r\n        }\r\n\r\n        return task.getSuggestions();\r\n    }\r\n}\r\npackage com.company.codequality.sonarautofix.service;\r\n\r\nimport com.company.codequality.sonarautofix.model.ScanTask;\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.stereotype.Service;\r\n\r\nimport java.io.BufferedReader;\r\nimport java.io.InputStreamReader;\r\n\r\n@Service\r\npublic class SonarService {\r\n\r\n    @Value(\"${sonar.token}\")\r\n    private String token;\r\n\r\n    @Value(\"${sonar.host.url}\")\r\n    private String sonarHost;\r\n\r\n    /**\r\n     * Runs Maven + Sonar scan\r\n     * Captures full build log into ScanTask\r\n     */\r\n    public void runSonarScan(String projectPath,\r\n            String projectKey,\r\n            ScanTask task) {\r\n\r\nStringBuilder output = new StringBuilder();\r\n\r\ntry {\r\n\r\nProcessBuilder builder = new ProcessBuilder(\r\n        \"C:\\\\Program Files\\\\Apache\\\\Maven\\\\bin\\\\mvn.cmd\",\r\n        \"clean\",\r\n        \"verify\",\r\n        \"-DskipTests=true\",\r\n        \"org.sonarsource.scanner.maven:sonar-maven-plugin:sonar\",\r\n        \"-Dsonar.projectKey=\" + projectKey,\r\n        \"-Dsonar.host.url=http://localhost:9000\",\r\n        \"-Dsonar.token=\" + token\r\n\r\n);\r\n\r\nbuilder.directory(new java.io.File(projectPath));\r\nbuilder.redirectErrorStream(true);\r\n\r\n\r\nProcess process = builder.start();\r\n\r\ntry (BufferedReader reader =\r\n        new BufferedReader(\r\n                new InputStreamReader(process.getInputStream()))) {\r\n\r\nString line;\r\n\r\nwhile ((line = reader.readLine()) != null) {\r\n   output.append(line).append(\"\\n\");\r\n}\r\n}\r\n\r\nint exitCode = process.waitFor();\r\n\r\ntask.setBuildLog(output.toString());\r\n\r\nif (exitCode != 0) {\r\nthrow new RuntimeException(\r\n       \"Sonar scan failed. Exit code: \" + exitCode\r\n);\r\n}\r\n\r\n} catch (Exception e) {\r\n\r\ntask.setBuildLog(output.toString());\r\n\r\nthrow new RuntimeException(\r\n   \"Sonar Scan Failed: \" + e.getMessage(),\r\n   e\r\n);\r\n}\r\n}\r\n}\r\n"
        }
    ]
}